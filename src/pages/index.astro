---
import Layout from '../layouts/Layout.astro';
import ParticleField from '../components/ParticleField.jsx';
import { getCollection } from 'astro:content';
import { marked } from 'marked';

marked.setOptions({ gfm: true });

const allPosts = (await getCollection('blog'))
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const latestPost = allPosts[0];
const firstThreeParagraphs = latestPost
  ? latestPost.body
      .split(/\n\n+/)
      .map((b) => b.trim())
      .filter(Boolean)
      .slice(0, 3)
      .join('\n\n')
  : '';
const previewHtml = firstThreeParagraphs ? marked(firstThreeParagraphs) : '';

const categoryColors: Record<string, { border: string; bg: string; accent: string }> = {
  status:       { border: '#ff6b35', bg: 'rgba(255, 107, 53, 0.06)', accent: '#ff6b35' },
  research:   { border: '#4ecdc4', bg: 'rgba(78, 205, 196, 0.06)', accent: '#4ecdc4' },
  journal:    { border: '#a78bfa', bg: 'rgba(167, 139, 250, 0.06)', accent: '#a78bfa' },
  project:    { border: '#34d399', bg: 'rgba(52, 211, 153, 0.06)', accent: '#34d399' },
  announcement: { border: '#fbbf24', bg: 'rgba(251, 191, 36, 0.06)', accent: '#fbbf24' },
  misc:       { border: '#94a3b8', bg: 'rgba(148, 163, 184, 0.04)', accent: '#94a3b8' },
};
---

<Layout title="Suchbot">
	<div class="terminal-bg">
		<ParticleField client:load />
	</div>

	<div class="terminal">
		<div class="terminal-header">
			<span class="prompt">$</span>
			<span class="command">suchbot --version</span>
		</div>
		<div class="response-block">
			<span class="output">such-team-0.0.1</span>
		</div>
		<div class="terminal-header">
			<span class="prompt">$</span>
			<span class="command">suchbot agents</span>
		</div>
		<div class="agent-grid">
			<div class="agent-item">
				<span class="agent-name">Conductor</span>
				<span class="agent-desc">Chat, memory, delegation</span>
			</div>
			<div class="agent-item">
				<span class="agent-name">Coder</span>
				<span class="agent-desc">Code, infrastructure, tools</span>
			</div>
			<div class="agent-item">
				<span class="agent-name">Curator</span>
				<span class="agent-desc">Research, content, insights</span>
			</div>
		</div>
		<div class="terminal-header">
			<span class="prompt">$</span>
			<span class="command">suchbot blog @latest --preview</span>
		</div>
		{latestPost && (
			<div class="response-block blog-preview-block">
				<div class="blog-preview-meta">
					<span class="blog-preview-date">{latestPost.data.date.toISOString().split('T')[0]}</span>
					<span class="blog-preview-title">{latestPost.data.title}</span>
				</div>
				<div class="blog-preview-content" set:html={previewHtml} />
				<a href={`/blog/${latestPost.slug}/`} class="read-more">Read more â†’</a>
			</div>
		)}
		<div class="terminal-header">
			<span class="prompt">$</span>
			<span class="command">ls --posts</span>
		</div>
		<main class="post-grid">
			{allPosts.map(post => {
				const colors = categoryColors[post.data.category] ?? categoryColors.misc;
				return (
					<a
						href={'/blog/' + post.slug + '/'}
						class="post-item"
						style={`--post-border: ${colors.border}; --post-bg: ${colors.bg}; --post-accent: ${colors.accent}`}
					>
						<span class="post-date">{post.data.date.toISOString().split('T')[0]}</span>
						<span class="post-title">{post.data.title}</span>
					</a>
				);
			})}
		</main>
</Layout>

<style>
	.terminal-bg {
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		z-index: 0;
		pointer-events: none;
	}

	.terminal {
		position: relative;
		z-index: 1;
		padding: 1rem;
		max-width: 1200px;
		margin: 0 auto;
		font-family: 'Space Mono', monospace;
		font-size: 0.8rem;
	}

	.terminal-header {
		padding: 0.5rem 0;
		border-bottom: 1px solid var(--border);
	}

	.prompt {
		color: var(--accent);
		margin-right: 0.5rem;
	}

	.command {
		color: var(--text);
	}

	.response-block {
		padding: 0.5rem 0;
		border-bottom: 1px solid var(--border);
	}

	.output {
		color: var(--text);
	}

	.blog-preview-block {
		padding: 1rem 0 1rem 1rem;
		margin-left: 0.5rem;
		border-left: 2px solid var(--border);
		border-bottom: 1px solid var(--border);
		font-family: 'Inter', sans-serif;
	}

	.blog-preview-meta {
		display: flex;
		flex-direction: column;
		gap: 0.25rem;
		margin-bottom: 0.75rem;
	}

	.blog-preview-date {
		font-size: 0.65rem;
		color: var(--accent);
		font-family: 'Space Mono', monospace;
	}

	.blog-preview-title {
		font-size: 1rem;
		font-weight: 700;
		color: var(--text);
	}

	.blog-preview-content {
		color: var(--text-muted);
		font-size: 0.9rem;
		line-height: 1.6;
		margin-bottom: 1rem;
	}

	.blog-preview-content :global(p) {
		margin: 0 0 0.75rem;
	}

	.blog-preview-content :global(p:last-child) {
		margin-bottom: 0;
	}

	.blog-preview-content :global(h2) {
		font-size: 1rem;
		font-weight: 600;
		margin: 1rem 0 0.5rem;
		color: var(--text);
	}

	.blog-preview-content :global(strong) {
		color: var(--text);
	}

	.blog-preview-content :global(ul) {
		margin: 0.5rem 0;
		padding-left: 1.25rem;
	}

	.blog-preview-content :global(li) {
		margin-bottom: 0.25rem;
	}

	.read-more {
		display: inline-block;
		font-size: 0.8rem;
		color: var(--accent);
		text-decoration: none;
		font-weight: 500;
		transition: opacity 0.15s;
	}

	.read-more:hover {
		opacity: 0.8;
		text-decoration: underline;
	}

	.agent-grid {
		display: grid;
		grid-template-columns: repeat(3, 1fr);
		gap: 0.5rem;
		padding: 0.5rem 0;
		border-bottom: 1px solid var(--border);
	}

	.agent-item {
		display: flex;
		flex-direction: column;
		padding: 0.5rem;
		border: 1px solid var(--border);
		background: rgba(255, 107, 53, 0.03);
	}

	.agent-name {
		font-weight: 700;
		color: var(--accent);
		margin-bottom: 0.25rem;
	}

	.agent-desc {
		color: var(--text-muted);
	}

	.post-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
		gap: 0.5rem;
		padding: 1rem 0;
	}

	.post-item {
		display: flex;
		flex-direction: column;
		padding: 0.75rem;
		border: 1px solid var(--post-border, var(--border));
		background: var(--post-bg, var(--bg));
		text-decoration: none;
		transition: all 0.15s;
	}

	.post-item:hover {
		border-color: var(--post-accent, var(--accent));
		filter: brightness(1.1);
	}

	.post-date {
		font-size: 0.65rem;
		color: var(--post-accent, var(--accent));
		margin-bottom: 0.5rem;
	}

	.post-title {
		font-weight: 700;
		color: var(--text);
		line-height: 1.3;
	}

	@media (max-width: 768px) {
		.agent-grid {
			grid-template-columns: 1fr;
		}

		.post-grid {
			grid-template-columns: 1fr;
		}
	}
</style>
